<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
   <head>
</head>
<body>
	<p><a id="editThisPageLink" target="_blank" style="color:blue">Edit this page</a></p>
	<div style="position: absolute; bottom: 200px">
		<div id="userNotLoggedInPanel">
			<button type="button" onclick="switchToVerifiedDeployment()">Simulate login (switch to verified deployment)</button>
		</div>
		<br>
		<div id="userLoggedInPanel" style="display: none">
			<button type="button" id="userVerificationButton" onclick="setUserAccessToken()">Set user verification token</button>
			<button type="button" id="logOutUserButton" onclick="switchToUnverifiedDeployment()">Simulate Logout (switch to unverified deployment)</button>
		</div>
	</div>


//this is a script to switch to a verified deployment
<script type='text/javascript'>
	document.getElementById('editThisPageLink').href = "https://github.com/ESW1234/esw1234.github.io/edit/master" + window.location.pathname;		
	
	function switchToVerifiedDeployment() {
		console.log("switching to verified deployment");
		//realistically this would be set by a customer's login function - we are simulating here for simplicity
		sessionStorage.setItem("USER_TOKEN", "123456";
		
		console.log("Clearing user session.");
		//save this reference so we know when we've finished with clearSession
		let emEl = document.getElementById("embedded-messaging")

		//end existing session, remove event handlers	
		embeddedservice_bootstrap.userVerificationAPI.clearSession(); //this also clears DOM elements
		waitForClearSession(emEl, loadVerifiedDeployment);
	}

	function switchToUnVerifiedDeployment() {
		console.log("switching to unverified deployment");
		sessionStorage.removeIte("USER_TOKEN");
		
		console.log("Clearing user session.");
		//save this reference so we know when we've finished with clearSession
		let emEl = document.getElementById("embedded-messaging");
		waitForClearSession(emEl, loadUnverifiedDeployment);
	}
	
	function loadUnverifiedDeployment() {
		loadBootstrapScript(
			"https://esw-sdb3-blitz.test1.my.pc-rnd.site.com/ESWwebMessaging041674063807205/assets/js/bootstrap.js", 
			"00DSB0000005YCL",
			"webMessaging03", 
			"https://esw-sdb3-blitz.test1.my.pc-rnd.site.com/ESWwebMessaging031674063746989",
			"https://esw-sdb3-blitz.test1.my.pc-rnd.salesforce-scrt.com");
		document.getElementById("userLoggedInPanel").style.display="none";
		document.getElementById("userNotLoggedInPanel").style.display="";
	}

	function loadVerifiedDeployment() {		
		loadBootstrapScript(
			"https://esw-sdb3-blitz.test1.my.pc-rnd.site.com/ESWwebMessaging041674063807205/assets/js/bootstrap.js", 
			"00DSB0000005YCL",
			"webMessaging04", 
			"https://esw-sdb3-blitz.test1.my.pc-rnd.site.com/ESWwebMessaging041674063807205",
			"https://esw-sdb3-blitz.test1.my.pc-rnd.salesforce-scrt.com);
		//show the user token button
		document.getElementById("userLoggedInPanel").style.display="";
		document.getElementById("userNotLoggedInPanel").style.display="none";
	}
	
	function waitForClearSession(emEl, callback) {
		//userVerificationAPI.clearSession() reloads ESW DOM elements; this is how we know it is finished
		if(document.getElementById("embedded-messaging") === emEl) {
			window.setTimeout( waitForClearSession, 100, emEl);
		} else {
			embeddedservice_bootstrap.removeMarkup();
			//remove remaining DOM items, event handler
			document.getElementById("bootstrapScript").remove();
			document.getElementById("embeddedMessagingSiteContextFrame").remove();
			embeddedservice_bootstrap.removeEventHandlers();	
			//now that we have called all the APIs we need, unset this so we can load other deployment
			embeddedservice_bootstrap = undefined;
			callback();
		}
	}

	function loadBootstrapScript(scriptUrl, orgId, deploymentName, siteUrl, scrtUrl) {
		var s = document.createElement('script');
		s.setAttribute('src', scriptUrl);
		s.setAttribute("bootstrapScript");
		s.onload = function() {
			try {
				embeddedservice_bootstrap.settings.language = 'en'; // For example, enter 'en' or 'en-US'
				embeddedservice_bootstrap.init(
					orgId,
					deploymentName,
					siteUrl,
					{
						scrt2URL: scrtUrl,
        			});
				
			} catch (err) {
				console.error('Error loading Embedded Messaging: ', err);
			}
		};
		document.body.appendChild(s);
	}

	function setUserAccessToken() {
		var token = prompt("Please enter user access token");
		embeddedservice_bootstrap.userVerificationAPI.setIdentityToken({"identityTokenType": "JWT", "identityToken": token});
	}
</script>

//This is the standard generated snippet for an unverified deployment
<script id="unauthBootstrapScript" type='text/javascript'>
	function initEmbeddedMessaging() {
		//use verified deployment if user token present, else unverified
		if (sessionStorage.getItem("USER_TOKEN")) {
			loadUnverifiedDeployment();
		} else {
			loadVerifiedDeployment();
		}
	};
</script>
<script id="unauthBootstrapScriptSrc" type='text/javascript' src='https://esw-sdb3-blitz.test1.my.pc-rnd.site.com/ESWwebMessaging031674063746989/assets/js/bootstrap.js' onload='initEmbeddedMessaging()'></script>

   </body>
</html>
    <style>
       body {
          
         background: url("https://esw1234.github.io/Spotify-large.png") no-repeat;
      }
      #button_goes_here{
            width: 100%; 
            height: 100%; 
            margin: 0 auto;
            position: relative;
            
      }
    </style>
